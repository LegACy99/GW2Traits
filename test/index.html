<!doctype html>
<head>
  <meta charset="utf-8">

  <title>My Parse App</title>
  <meta name="description" content="My Parse App">
  <meta name="viewport" content="width=device-width">
  <link rel="stylesheet" href="css/reset.css">
  <link rel="stylesheet" href="css/styles.css">
  <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
  <script type="text/javascript" src="http://www.parsecdn.com/js/parse-1.2.18.min.js"></script>
</head>

<body>
  
  <div id="main">
    <h1>You're ready to use Parse!</h1>

    <p>Read the documentation and start building your JavaScript app:</p>

    <ul>
      <li><a href="https://www.parse.com/docs/js_guide">Parse JavaScript Guide</a></li>
      <li><a href="https://www.parse.com/docs/js">Parse JavaScript API Documentation</a></li>
    </ul>

    <ul id="traits"></ul>
    <ul id="maps"></ul>

    <div style="display:none" class="error">
      Looks like there was a problem saving the test object. Make sure you've set your application ID and javascript key correctly in the call to <code>Parse.initialize</code> in this file.
    </div>

    <div style="display:none" class="success">
      <p>We've also just created your first object using the following code:</p>
      
        <code>
          var TestObject = Parse.Object.extend("TestObject");<br/>
          var testObject = new TestObject();<br/>
          testObject.save({foo: "bar"});
        </code>
    </div>
  </div>

  <script type="text/javascript">
  	//Global variables
	var MapCount 		= {};
	var TraitMaps		= {};
	//Sort maps from map count
  	function sortMaps() {
  		//For each map
		var Sorted = [];
		for (var Name in MapCount) {
			//If not sorted yet, just insert it
			if (Sorted.length <= 0) Sorted[0] = Name;
			else {
				//Find index to be inserted
				Index = -1;
				for (var i = 0; i < Sorted.length && Index < 0; i++) if (MapCount[Name] >= MapCount[Sorted[i]]) Index = i;
				if (Index < 0) Index = Sorted.length;

				//Insert at index
				Sorted.splice(Index, 0, Name); 
			}
		}

		//Return sorted map
		return Sorted;
  	}

  	//Display maps
  	function displayMaps(maps) {
  		//Skip if no map
  		if (maps == null) return;

		//For each map
		var MapList = "";
		for (var i = 0; i < maps.length; i++) {
			//Set string
			MapList += "<li>" + maps[i]; 
			if (MapCount[maps[i]] != null) MapList += " - " + MapCount[maps[i]];
			MapList += "</li>";
		}

		//Write
		document.getElementById('maps').innerHTML = MapList;
  	}

  	//Checkbox click
  	function onTraitClick(element) {
  		//Get map
  		var MapName = TraitMaps[element.id];
  		if (MapName != null) {
  			//Manage count
  			MapCount[MapName] += element.checked ? -1 : 1;

	  		//Redraw
	  		var Sorted = sortMaps();
	  		displayMaps(Sorted);
  		}
  	}

	//Initialize
	Parse.initialize("SDiJ7OLjISzQIt2RTOgQOTlCh8Nj0xPHwm17Isq2", "mkJfAEKHWnCkUgFT7a2Z7Btf0PGoUdBZzMbtqLTd");
    
	/*var TestObject = Parse.Object.extend("TestObject");
	var testObject = new TestObject();
	  testObject.save({foo: "bar"}, {
	  success: function(object) {
		$(".success").show();
	  },
	  error: function(model, error) {
		$(".error").show();
	  }
	});*/

	//Query all traits
	var TraitObject = Parse.Object.extend("Trait");
	var TraitQuery	= new Parse.Query(TraitObject);
	
	TraitQuery.include("map");
	TraitQuery.find({
		success: function(traits) {
			//For each result
			var TraitList = "";
			for (var i = 0; i < traits.length; i++) {
				//Start trait item list
				TraitList += '<li>Trait ' + traits[i].get("line") + '-' + traits[i].get("number");

				//Get map
				var Map = traits[i].get("map");
				if (Map != null) {
					//Save
					var MapName 			= Map.get("name");
					TraitMaps[traits[i].id] = MapName;

					//Extend string
					TraitList += " at " + MapName;

					//Increment
					if (MapCount[MapName] == null) 	MapCount[MapName] = 1;
					else 							MapCount[MapName]++;
				}

				//Close
				TraitList += ' <input id="' + traits[i].id + '" type="checkbox" onclick="onTraitClick(this)"></li>';
			}

			//Write trait
			document.getElementById('traits').innerHTML = TraitList;

			//Write map
			var Sorted = sortMaps();
			displayMaps(Sorted);
		}
	});
  </script>
</body>

</html>
